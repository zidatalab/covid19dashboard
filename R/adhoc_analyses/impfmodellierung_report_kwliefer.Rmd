---
title: "Ärztliche Praxen werden zur Unterstützung der Impfzentren gebraucht"
author: "Thomas Czihal, Lars Kroll, Dominik von Stillfried, Edgar Steiger"
date: "4 2 2021"
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=7, fig.height=7 *9/16)
```

```{r import, include=FALSE}
library(kableExtra)
source("R/adhoc_analyses/Impfmodellierung_ES_kwlieferungen.R")
```

# Zusammenfassung

Ziel der vorliegenden Modellrechnungen ist die Entwicklung eines quantitativen Gerüsts für den zukünftigen Verlauf der nationalen Impfkampagne. Grundlage sind die im Rahmen des Impfgipfels bereitgestellte Informationen zu möglichen Liefermengen und zur bundesweiten Kapazität der Impfzentren.

Die Modellrechnungen zeigen, dass noch im ersten Quartal die verfügbaren Impfstoffmengen die bestehenden Kapazitäten der Impfzentren übersteigt. Bis zum 21. September kann mit einer wöchentlichen Impfstoffverfügbarkeit von 900tsd- bis 9,7 Mio. Dosen ausgegangen werden. Die Kapazität der Impfzentren beträgt derzeit 1,4. Mio. Impfungen pro KW und kann sicherlich auf 2,1 Mio. Impfungen gesteigert werden.
Unter der Annahme der Steigerung der Kapazität in den Impfzentren sind noch im ersten Quartal über 6.000 Praxen, im zweiten Quartal bis zu 40.000 Praxen und im dritten Quartal über 80.000 Praxen notwendig, um die Differenz zwischen verfügbarem Impfstoff und Kapazität der Impfzentren zu schließen.

Im Ergebnis zeigt sich, dass für einen zügigen Impffortschritt schnellstmöglich die Voraussetzungen für Impfungen in den Arztpraxen geschaffen werden müssen. Diese müssen bis in das dritte Quartal als komplementär zu den Impfzentren gestaltet werden, ein Abbau der Kapazitäten der Impfzentren scheint frühestens im vierten Quartal realistisch. Da diese Modeliierungen dynamisch angepasst werden müssen, wird ein Simulationswerkzeug entwickelt, indem einfach verschiedene Szenarien betrachtet werden können. Dieses Werkzeug kann voraussichtlich bis zum 17. Februar bereitgestellt werden.    


# Annahmen, Parameter und Szenarien

<!-- Mit den zugelassenen Impfstoffen sind derzeit nur Impfungen an Personen über 18 Jahren möglich.  -->

Wir modellieren mit ca. 400 Impfzentren in Deutschland, die insgesamt täglich 200.000 Impfungen durchführen können (Montag bis Sonntag). Weiterhin rechnen wir mit etwa 50.000 vertragsärztlichen Praxen, in denen mindestens jeweils 20 Impfungen pro Tag möglich sind (Montag bis Freitag). Damit können in diesen Praxen theoretisch mehr als 700.000 Impfungen pro Tag im Wochenmittel bzw. 5 Millionen Impfungen pro Woche durchgeführt werden. In unserer Modellierung gehen wir, davon aus, dass die Praxen die Impfungen übernehmen, die die Kapazitätsgrenze der Impfzentren übersteigt.

Für die zukünftige Planung berücksichtigen wir die verabredeten Impfstofflieferungen je nach Hersteller, sowie die nach heutigem Stand bereits verabreichten (RKI) und gelieferten Impfstoffdosen. In erweiterten Leistungsfähigkeits-Szenarien berechnen wir unsere Ergebnisse für Impfzentren mit erhöhter Leistungsfähigkeit (300.000 Impfungen gesamt pro Tag). Damit ergeben sich für die Impfzentren werk- und wochentägliche Kapazitäten je nach Einrichtung wie in Abbildung 1 dargestellt.


**Abb. 1: Leistungsfähigkeit der Impfzentren**

```{r szenarientabelle, echo=FALSE, fig.height=4 *9/16}
szenarien %>% rename("Mo-Fr"=	kap_wt	, "Sa+So"=kap_we)  %>% gather(Merkmal,Wert,2:3) %>%
  mutate(Wert=ifelse(Merkmal=="Sa+So", 2*Wert, 5*Wert),
         Merkmal=factor(Merkmal, ordered = TRUE, levels = c("Sa+So", "Mo-Fr"))) %>% ggplot(aes(x=szenario,fill=Merkmal,y=Wert/1000)) + geom_bar(pos="stack",stat="identity") + coord_flip() + theme_minimal() + scale_fill_zi() + labs(x="",y="Anzahl wöchentlicher Impfungen in Tsd.", fill="")
```

Für die Lieferungen berücksichtigen wir zwei Lieferungs-Szenarien: Im ersten Szenario werden die quartalsweise zugesicherten Lieferungen gleichmäßig auf die Monate des Quartals verteilt (“Gleichverteilung”), im zweiten Szenario (“Linearer Anstieg”) verschieben sich die zugesagten Lieferungen bis Juni nach hinten, sodass im 2. Quartal im April 20%, im Mai 35% und dafür im Juni 45% der für das Quartal jeweils durch die Hersteller zugesicherten Dosen geliefert werden. Die zugesagten Lieferungen sind in Abbildung 2 dargestellt.

**Abb. 2: Bis Quartal 4 zugesagte Impfdosen, Quartal 1 ink. 2020**

```{r hersteller, warning=FALSE,echo=FALSE,}
dosen_planung %>% ggplot(aes(x=hersteller,y=dosen/1e6,fill=as.character(quartal))) + geom_bar(position = position_stack(reverse = TRUE), stat="identity") + coord_flip() + labs(x="",y="Mio. Dosen",fill="Quartal") + 
  theme_minimal() + scale_fill_zi()
```


# Modellierung

In unseren Modellierungen für die verschiedenen Leistungsfähigkeits- und Lieferszenarien gehen wir zunächst von den Kapazitäten der Impfzentren aus. Verfügbare monatliche Dosen werden im ersten Schritt für die Auslastung der Impfzentren benutzt, bis diese Kapazität (z.B. 200.000 Impfungen täglich im Regelbetrieb) erschöpft ist. Die überzähligen Dosen werden dann ärztlichen Praxen zugerechnet, die diese dezentral verimpfen können. Wir berechnen, wie viele impfende Praxen für einen Monat nötig sind, um die Impfzentren zu unterstützen und die vorhandenen Impfstoffdosen auszuschöpfen. 

In der aktuellen Darstellung wird ohne weitere Rückstellungen für die Folgeimpfung gerechnet und bisher zurückgestellte Impfdosen auf die nächsten 21 Tage verteilt verimpft.

# Ergebnisse

**Abb. 4: Modellierte Auslastung der Impfzentren nach KW**

```{r outputplot1, warning=FALSE, echo=FALSE}
# output.plot1 <- output %>% mutate(#szenario = paste(szenario,Verteilungsszenario),
#                                   Monat=month(Datum, label=TRUE)) %>%
#   filter(jahr>=2021) %>% 
#   ggplot(aes(x=Monat, y=IZ_Auslastung, fill=szenario)) +
#   facet_wrap(.~Verteilungsszenario) +
#   geom_bar(stat="identity", position = "dodge") + #scale_x_date(breaks = "1 month") +
#   geom_hline(yintercept=100) +
#   scale_fill_zi() + theme_minimal() + theme(legend.position="bottom")
# 
ann_text <- data.frame(kw = 36.5, reverseAuslastung = 0, lab = "21.9.", szenario="IZ Regelbetrieb", Verteilungsszenario="Linearer Anstieg der Produktion in Q2")
ann_text_q <- data.frame(kw = c(5, 13, 26), reverseAuslastung = 0, lab = c("Q1", "Q2", "Q3"), szenario="IZ Regelbetrieb", Verteilungsszenario="Linearer Anstieg der Produktion in Q2")
output.plot1kw <- output %>%
  mutate(reverseAuslastung=1/(IZ_Auslastung/100)*100) %>%
  filter(jahr>=2021 & quartal<=3) %>%
  ggplot(aes(x=kw, y=reverseAuslastung, color=szenario, group=szenario)) +
  facet_wrap(.~Verteilungsszenario, ncol=1) +
  geom_line(size=3) + # scale_x_date(breaks = "1 month") +
  geom_text(data = ann_text, aes(label = lab), col="black", size=3.5) +
  geom_text(data = ann_text_q, aes(label = lab), col="darkgrey", size=3) +
  ylim(0, NA) +
  # geom_hline(yintercept=100,  linetype="dashed") + 
  geom_vline(xintercept=38) +
  # geom_vline(xintercept = isoweek(as_date(c("2020-04-01", "2020-07-01"))), color="lightgrey", linetype="dotted") +
  labs(color="", x="KW", y="Anteil (%) in Impfzentren\nverimpfbarer Impfdosen")+
  scale_color_zi() + theme_minimal() + theme(legend.position="bottom")
output.plot1kw
```

Es wird deutlich, dass bereits ab April die vertragsärztlichen Praxen unbedingt einspringen müssen, um die gelieferten Impfstoffe zügig zu verimpfen. Ab Juli bzw. im 3. Quartal sollten sämtliche geeignete Praxen Impfungen durchführen.


**Abb. 5: Modellierte Unterstützungsbedarf durch Vertragsärzte nach KW**

```{r outputplot2, warning=FALSE, echo=FALSE}
# output.plot2 <- output %>% mutate(#szenario = paste(szenario,Verteilungsszenario),
#                                   Monat=month(Datum, label=TRUE)) %>%
#   filter(jahr>=2021) %>% 
#   ggplot(aes(x=Monat, y=Zusatzbedarf_n_Aerzte, fill=szenario)) +
#   facet_wrap(.~Verteilungsszenario) +
#   geom_bar(stat="identity", position = "dodge") + # scale_x_date(breaks = "1 month") +
#   geom_hline(yintercept=0,) +
#   scale_fill_zi() + theme_minimal() + theme(legend.position="bottom")
# 
ann_text <- data.frame(kw = 36.5, Zusatzbedarf_n_Aerzte = 10000, lab = "21.9.", szenario="IZ Regelbetrieb", Verteilungsszenario="Linearer Anstieg der Produktion in Q2")
ann_text_q <- data.frame(kw = c(5, 13, 26), Zusatzbedarf_n_Aerzte = -7000, lab = c("Q1", "Q2", "Q3"), szenario="IZ Regelbetrieb", Verteilungsszenario="Linearer Anstieg der Produktion in Q2")
output.plot2kw <- output %>% mutate(#szenario = paste(szenario,Verteilungsszenario),
  Monat=month(Datum, label=TRUE)) %>%
  filter(jahr>=2021 & quartal<=3) %>%
  ggplot(aes(x=kw, y=Zusatzbedarf_n_Aerzte, color=szenario, group=szenario)) +
  facet_wrap(.~Verteilungsszenario, ncol=1) +
  geom_line(size=3) + # scale_x_date(breaks = "1 month") +
  geom_text(data = ann_text, aes(label = lab), col="black", size=3.5) +
  geom_text(data = ann_text_q, aes(label = lab), col="darkgrey", size=3) +
  # annotate("text", label = "21.9.", x = 37, y = 50, , size = 3) +
  ylim(-7000, NA) +
  # scale_y_continuous(breaks = c(0,200,400,600)) +
  geom_hline(yintercept=0, linetype="dashed") + 
  geom_vline(xintercept=38) +
  labs(color="", x="KW", y="Anzahl zusätzlich notwendiger Ärzte")+
  scale_color_zi() + theme_minimal() + theme(legend.position="bottom")
output.plot2kw
```

**Abb. 6: Potenziell zu verimpfende Dosen nach Szenario **

```{r dosenkumuliert, warning=FALSE, echo=FALSE}
bisher_verimpft <- dosen_verabreicht %>% ungroup() %>% summarise(verimpft=sum(dosen_verabreicht_erst+dosen_verabreicht_zweit)) %>% pull(verimpft)
plot6data <-bind_rows(
output %>% select(Verteilungsszenario, szenario,Datum,kw,verimpft=IZ_verimpft,Zusatzbedarf) ,
output %>% select(Verteilungsszenario, szenario,Datum,kw,IZ_verimpft,Zusatzbedarf) %>%
filter(szenario=="IZ Regelbetrieb") %>% mutate(szenario="IZ + Vertragsärzte") %>%
mutate(verimpft=IZ_verimpft+Zusatzbedarf)) %>%
group_by(Verteilungsszenario, szenario) %>% arrange(Verteilungsszenario, szenario,Datum) %>%
mutate(kum_verimpft=cumsum(verimpft)+bisher_verimpft,
label=factor(szenario,levels=c("IZ Intensivbetrieb", "IZ + Vertragsärzte","IZ Regelbetrieb"),ordered = TRUE))

ann_text <- data.frame(kw = 36, kum_verimpft1e6 = 10, lab = "21.9.", szenario="IZ Regelbetrieb", Verteilungsszenario="Linearer Anstieg der Produktion in Q2")
ann_text_q <- data.frame(kw = c(5, 13, 26), kum_verimpft1e6 = -10, lab = c("Q1", "Q2", "Q3"), szenario="IZ Regelbetrieb", Verteilungsszenario="Linearer Anstieg der Produktion in Q2")

ggplot(plot6data %>% filter(quarter(Datum)<=3) %>%
         mutate(kum_verimpft1e6=kum_verimpft/1e6),
       aes(x=kw,y=kum_verimpft1e6,color=label)) + geom_line(size=3) +
facet_wrap(Verteilungsszenario ~. , ncol=2) +scale_color_zi() + theme_minimal() + labs(color="Szenario Impforganisation", y="Potentiell verimpfbare Dosen in Mio.",x="KW") + geom_hline(yintercept = 0) + theme(legend.position = "bottom") +
geom_vline(xintercept=38) +
  ylim(-10, NA) +
geom_hline(yintercept = 2*impflinge_gesamt/1e6, linetype = "dashed") +
    geom_text(data = ann_text, aes(label = lab), col="black", size=3.5) +
  geom_text(data = ann_text_q, aes(label = lab), col="darkgrey", size=3)
# geom_vline(xintercept = isoweek(as_date(c("2020-04-01","2020-07-01"))),color="darkgrey")



```


