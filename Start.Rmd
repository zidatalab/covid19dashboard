---
title: "Zi-Frühindikatoren zu COVID-19"
output: 
  flexdashboard::flex_dashboard:
    navbar:
       - { title: "Dashboard", href: "Start.html", align: left }
       - { title: "Bundesländer", href: "Bundeslaender.html", align: left }
       - { title: "Kreise", href: "Kreise.html", align: left }
       - { title: "Impressum", href: "Impressum.html", align: left }
    orientation: rows
    vertical_layout: scroll 
    logo: static/logo.png
    theme: bootstrap
    css: static/styles.css
---

```{r setup, include=FALSE}
library(flexdashboard)
# Packages
library(DT)
library(DBI)
library(forcats)
library(EpiEstim)
library(plotly)
library(zicolors)
library(deSolve)
library(jsonlite)
library(readxl)
library(data.table)
library(dplyr)
library(glue)
library(lubridate)
library(tidyverse)
library(tidyr)
library(stringr)
library(ggplot2)
library(dtplyr)
source("R/functions.R", encoding = "UTF-8")
# load("test.RData")
```

Row
------------------------------------------------------------------------

### **Zi-Frühindikatoren:** 

Das Zi hat Frühindikatoren entwickelt, die frühzeitig auf die Gefahr für die Überlastung des Gesundheitswesens durch COVID-19 hinweisen sollen. Nachfolgend wird unsere tägliche Lageeinschätzung im Hinblick auf diese Indikatoren dargestellt. Nähere Informationen finden Sie [hier](https://www.zidatasciencelab.de/covid19dashboard/static/2020-10-30_Methodenpapier_Vorwarnzeit_Fassung_3.pdf). **Hinweis: Wir haben die Methodik verbessert (17.11.2020). Das Methodenpapier wird zeitnah aktualisiert.** 

Stand Zi-Dashboard: `r format(now(),format="%d.%m.%Y %H:%M Uhr")`

Stand RKI-Meldedaten: `r format(as_date(max(rki$Datenstand, na.rm = TRUE)),format="%d.%m.%Y")`; Stand DIVI-Intensivregister: `r format(as_date(max(divi$daten_stand, na.rm = TRUE)),format="%d.%m.%Y")`

Row 
------------------------------------------------------------------------

### Reproduktionszahl 

```{r indicatorR}
indicatorR <- aktuell %>% filter(id==0) %>% collect() %>% pull(R0)
valueBox(value= paste("R =",format(indicatorR,digits=2,decimal.mark = ","))  ,
         caption="Reproduktionszahl",
         color = case_when(indicatorR < 1.0 ~ "#B1C800",
                           indicatorR >= 1.0 & 
                             indicatorR < 1.3 ~ "#E49900",
                           indicatorR >= 1.3 ~ "#E40000"),
         icon = "fa-users"
        )
```

Row 
------------------------------------------------------------------------

### Neue Fälle je 100.000 Einwohnende in 7 Tagen

```{r indicator7TI}
faelleprotag <-  vorwarnzeitergebnis %>% filter(id==0 & date==maxdatum) %>% pull(Faelle_letzte_7_Tage_pro_Tag)
faelle7tage100kEW <-  vorwarnzeitergebnis %>% filter(id==0 & date==maxdatum) %>% pull(Faelle_letzte_7_Tage_je100TsdEinw)
valueBox(faelle7tage100kEW,
         caption=paste0("Neue Fälle je 100.000 Einwohnende in 7 Tagen \n unter 60-Jährige: ",
                        letzte_7_tage_altersgruppen_bund %>% pull(`Faelle_letzte_7_Tage_je100TsdEinw_0-59`),
                        ", 60- bis 79-Jährige: ",
                        letzte_7_tage_altersgruppen_bund %>% pull(`Faelle_letzte_7_Tage_je100TsdEinw_60-79`),
                        ", Über-80-Jährige: ",
                        letzte_7_tage_altersgruppen_bund %>% pull(`Faelle_letzte_7_Tage_je100TsdEinw_80+`)),
         icon = "fa-chart-line",
         color = case_when(faelle7tage100kEW < 35 ~ "#B1C800",
                           faelle7tage100kEW >= 35 & 
                             faelle7tage100kEW < 50 ~ "#E49900",
                           faelle7tage100kEW >= 50 ~ "#E40000")
        )
```

Row 
------------------------------------------------------------------------

### Vorwarnzeit bei R=1,3 

```{r indicatorVWZ}
vorwarnzeitaktuell <- vorwarnzeitergebnis %>% filter(id==0 & date==maxdatum) %>%
  pull(Vorwarnzeit)
valueBox(paste(vorwarnzeitaktuell,"Tage"),
         caption=paste0("Vorwarnzeit bis Erreichen der Kapazitätsgrenze \n effektive Vorwarnzeit: ", vorwarnzeitergebnis %>% filter(id==0 & date==maxdatum) %>% pull(Vorwarnzeit_effektiv), " Tage"),
         icon = "fa-calendar-alt",
         color = case_when(vorwarnzeitaktuell > 81 ~ "#B1C800",
                           vorwarnzeitaktuell <= 81 & 
                             vorwarnzeitaktuell >= 22 ~ "#E49900",
                           vorwarnzeitaktuell < 22 ~ "#E40000") 
        )
```

Row
------------------------------------------------------------------------

### Legende:

***Reproduktionszahl R***: Anzahl der Personen, die eine infizierte Person durchschnittlich mit COVID-19 infiziert. \
***Neue Fälle je 100.000 Einwohnende in 7 Tagen***: Auch als "7-Tage-Inzidenz" oder "Handlungsgrenze" bezeichnet. Wegen Meldeverzügen fehlen für einige Kreise/Bundesländer die Fallzahlen des Vortages. Fehlende Werte imputieren wir mit dem Mittelwert der vorhergehenden 6 Tage, um die 7-Tage-Inzidenz vergleichbarer zu machen. \
***Vorwarnzeit bei R=1,3***: Anzahl von Tagen bis zur Überschreitung der stationären Behandlungskapazitäten (Annahme: für zukünftige COVID-19-Fälle stehen die derzeit freien Betten sowie bereits mit COVID-19-Fällen belegte Betten zur Verfügung) ab heute, falls R=1,3 ab dem `r format(now(),format="%d.%m.%Y")`. Wir berücksichtigen die aktuelle Altersstruktur der Infizierten und unterschiedliche Raten der Intensivfälle: `r round(icurate_altersgruppen_busse$Hosp059*100, 2)`% für Unter-60-Jährige, `r round(icurate_altersgruppen_busse$Hosp6079*100, 2)`% für 60-bis-79-Jährige, sowie `r round(icurate_altersgruppen_busse$Hosp80*100, 2)`% für Über-80-Jährige. Diese Quoten wurden auf Basis der im Intensivregister gemeldeten Fälle mit Korrektur für Doppelzählungen auf Grund von Verlegungen (27%) sowie COVID-19-Charakteristiken aus der Literatur bestimmt. Die "effektive Vorwarnzeit" ist die Vorwarnzeit abzüglich der angenommenen Reaktionszeit von 21 Tagen, bis ergriffene neue Maßnahmen wirken. Vgl. Methodenpapier.

Row
------------------------------------------------------------------------
### **Entwicklung der akut Infizierten**

```{r plotakutinfiziert}
ggplotly(akutinfiziert_plot + labs(title="")) %>% 
   config(displayModeBar = FALSE, responsive=TRUE)
```

Row
------------------------------------------------------------------------
### Erläuterung

Dargestellt ist die Entwicklung der Anzahl von akut infizierten Personen in Deutschland. Angenommen wird, dass die Personen i.d.R. 15 Tage nach der gemeldeten Erkrankung nicht mehr akut infiziert sind. Die Zahl hatte am 6.4.2020 ihren bisherigen Höhepunkt in der ersten Welle von ca. 74 Tsd. Personen. 

Row
------------------------------------------------------------------------

### **Entwicklung des Alters der Infizierten sowie des Verhältnis von ITS- und Todesfällen zu gemeldeten Fällen**

```{r plotagefatality}
ggplotly(agefatality_plot, tooltip = c("x", "y")) %>%
  layout(legend = list(orientation = "h", x = 0.1, y = 1.2), autosize=TRUE) %>%
  config(displayModeBar = FALSE, responsive=TRUE)
```

Row 
------------------------------------------------------------------------
### Erläuterung

Dargestellt ist die Entwicklung des Anteils von neu gemeldeten akut infizierten Personen im Alter ab 60 Jahren an allen gemeldeten Fällen in Deutschland. Zudem wird das Verhältnis von Todesfällen an den gemeldeten Fällen dargestellt, sowie das Verhältnis der auf der Intensivstation behandelten Fälle (ITS) an der Zahl der akut Infizierten zwei Wochen davor (es dauert etwa 14 Tage, bis eine schwere COVID-19-Infektion intensivmedizinisch behandelt werden muss). Daten für ITS-Fälle liegen erst ab Ende April vor. Die Zahl der Todesfälle ist für die letzten Wochen noch nicht aussagekräftig, da ein Todesfall meist nach schwerem und langem Krankheitsverlauf eintritt.


Row
------------------------------------------------------------------------
### **Entwicklung der Reproduktionszahl**

```{r plotBLR}
ggplotly(rwert_bund_plot, tooltip = c("x", "y", "text")) %>%
  config(displayModeBar = FALSE, responsive=TRUE)

```

Row
------------------------------------------------------------------------

### Erläuterung

Dargestellt ist die Entwicklung der Reproduktionszahl R auf Ebene des Bundes. R beschreibt die mittlere Anzahl von Neu-Infektionen, die von einer Person im Laufe ihrer COVID-19-Infektion angesteckt werden. R wird aus den Meldedaten des RKI geschätzt.


Row
-----------------------------------------------------------------------

### **Entwicklung der Vorwarnzeit (und Vergleich zum R-Wert des RKI)**

```{r plotVWZR}
ggplotly(rki_r_und_zi_vwz_plot, tooltip = c("x", "y", "text")) %>%
  config(displayModeBar = FALSE, responsive=TRUE)
```

Row
------------------------------------------------------------------------

### Erläuterung

Dargestellt ist die Entwicklung der Zi-Vorwarnzeit für die BRD, ebenso zum Vergleich die Entwicklung des (7-Tage-)R-Wertes, wie er vom RKI gemeldet wird.

Row
------------------------------------------------------------------------
### Methodischer Hinweis zum R-Wert:

*In die Berechnung des R-Wertes gehen verschiedene Annahmen ein, da der Wert aufgrund unvollständiger Informationen zu Infektionsketten in der Regel geschätzt werden muss. Die Methodik des Zi und des RKI unterscheiden sich dabei in zwei zentralen Punkten. Das RKI betrachtet die neuen Erkrankten nach Erkrankungsdatum im Vergleich von zwei 4-Tages-Perioden und nimmt dadurch eine 4-tägige-Ansteckungsperiode an. Dabei müssen für etwa ein Drittel der Infizierten das Erkrankungsdatum geschätzt und Nachmeldungen durch das sog. Nowcasting interpoliert werden. Zusätzlich berechnet das RKI einen 7-Tage-R-Wert, bei dem vor der Betrachtung mit 4-Tages-Perioden zunächst für jeden Tag ein rollender 7-Tage-Mittelwert berechnet wird, um wochentägliche Schwankungen auszugleichen. Das Zi verwendet das Meldedatum als Infektionsbeginn und berücksichtigt eine längere Infektionsperiode, in der die meisten Ereignisse am 4. Tag auftreten, Ansteckungen aber auch später auftreten können (Gamma-Verteilung mit MW=4, SD=5). Alle Ansätze haben Vor- und Nachteile und zeigen langfristig die gleiche Tendenz an. Sowohl das Zi als auch das RKI schließen bei der Berechnung der R-Werte die Fallzahlen der letzten 4 Tage aus, da diese noch zu unverlässlich wegen Meldeverzügen sind.*

```{r renderothersites, include=FALSE}
rmarkdown::render('Bundeslaender.Rmd')
rmarkdown::render('Kreise.Rmd')
rmarkdown::render('Impressum.Rmd')
# rmarkdown::render('Test.Rmd')
```

